<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script src="https://unpkg.com/bcryptjs@2.4.3/dist/bcrypt.js"></script>
</head>

<body>
  <script>
    let connections = 0

    async function setup() {
      let res = await fetch("/get")
        .then((res) => res.json())
        .then((data) => data);
      if (res.code === 0) {
        console.log("fetch from client")
        createPeerWithConnection(res.id, res.checksum)
      } else {
        console.log("fetch from server")
        setData(res.html)
        createPeerWithoutConnection(res.html)
      }
    }
    setup()

    function createPeerWithoutConnection(html) {
      let peer = new Peer(undefined, {
        host: window.location.hostname,
        port: 3000,
        path: "/peerserver"
      })
      peer.on("open", () => {
        peer.on('connection', function (conn) {
          connections++
          console.log(connections + ". From: " + conn.peer)
          conn.on("open", () => {
            conn.send(html)
          })
        });
      })
    }


    function createPeerWithConnection(connid, checksum) {
      let peer = new Peer(undefined, {
        host: window.location.hostname,
        port: 3000,
        path: "/peerserver"
      })
      peer.on("open", () => {
        let conn = peer.connect(connid);
        conn.on('data', function (data) {
          peer.destroy()
          createPeerWithoutConnection(data)
          if (dcodeIO.bcrypt.compareSync(JSON.stringify(data), checksum)) {
            setData(data)
          } else {
            async function getDirekt() {
              let res = await fetch("/html")
                .then((res) => res.json())
                .then((data) => data);
              setData(res.html)
              createPeerWithoutConnection(res.html)
            }
            console.log("fallbach to server")
            getDirekt()
          }
        })
      })
    }

    function setData(html) {
      document.head.innerHTML = html.head;
      document.body.innerHTML = html.body;
    }
  </script>
</body>

</html>